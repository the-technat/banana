# 01 - Operating System

As page 00 says, we're using Ubuntu 22.04 for my nodes. This is because I wanted to handle everything myself and really understand what K8s needs in order to work. So goodby `flatcar`, `coreos`and `micro os`.

## User

Every system I use must have a user called `technat` that has a public-key added, a password and the following alias in it's RC config:
dd

`alias l='ls -lahF --hyperlink=auto'`

## SSH config

Every system I use must have the following SSH config:

```
Port 59245
PermitRootLogin no
PermitEmptyPasswords no
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no
UsePAM yes
X11Forwarding no
PrintMotd no
AcceptEnv LANG LC_*
Subsystem    sftp    /usr/lib/openssh/sftp-server
Include /etc/ssh/sshd_config.d/*.conf
```

## Firewall

Every system I use mustn't have a firewall configured. Remove all host-level firewalls and cloud-provider firewalls. We later secure this using cilium.

## Unattended-Upgrades

We want our kubernetes nodes to be up to date, so we enable automatic upgrades over night.

Paste the following content into `/etc/apt/apt.conf.d/50unattended-upgrades`:

```
Unattended-Upgrade::Allowed-Origins {
 "${distro_id}:${distro_codename}";
 "${distro_id}:${distro_codename}-security";
 "${distro_id}ESMApps:${distro_codename}-apps-security";
 "${distro_id}ESM:${distro_codename}-infra-security";
 "${distro_id}:${distro_codename}-updates";
 "${distro_id}:${distro_codename}-proposed";
 "${distro_id}:${distro_codename}-backports";
};

Unattended-Upgrade::DevRelease "auto";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::SyslogEnable "true";
```

And enable the service:

```bash
sudo systemctl enable --now unattended-upgrades.service
```

## K8s Prerequisites

The [kubeadm guide](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/) lists some prerequisites that a node must have:

- swap must be disabled
- static IP on the eth0 interface (already given)
- containerd installed
  - on ubuntu we get it through the docker repo, there it's named `containerd.io`
- kubelet installed (using apt repos)
- `net.bridge.bridge-nf-call-iptables=1`in sysctl
- `net.ipv4.ip_forward=1` in sysctl
- `net.bridge.bridge-nf-call-ip6tables=1`in sysctl
- module `overlay` loaded
- module `br_netfilter` loaded
- all components using systemd cgroup v2
  - for grub based systems this is `GRUB_CMDLINE_LINUX="systemd.unified.cgroup_hierarchy=1"`
  - for containerd this is `SystemdCgroup = true`
- kubelet package on hold (not automatically upgraded)
- containerd package on hold (not automatically upgraded)

The following resources can be helpful to met those prerequisites:

- [install kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)
- [my blog article about k8s kubeadm way](https://technat.ch/kubernetes/k8s_kubeadm/)

### /var dir

Containers take up a lot of space, so make sure `/var` gets as much space as it can get.

I wrote a [guide](https://github.com/the-technat/the-technat/blob/main/content/Kubernetes/lv-extending.md) how to do this with LVM some time ago...

Or if like ubuntu on hcloud, there is no separation between `/var` and `/` we can also skip this step.

### kubelet flags

When the node is running on hcloud, add the following flag:

```bash
cat <<EOF | sudo tee /etc/systemd/system/kubelet.service.d/20-hcloud.conf
[Service]
Environment="KUBELET_EXTRA_ARGS=--cloud-provider=external"
EOF
sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

### Additional tools

Get the following tools:

- [helm](https://helm.sh/docs/intro/install/)
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/)

## Next step

-> [02 Cluster initialization](./02_cluster_init.md)
